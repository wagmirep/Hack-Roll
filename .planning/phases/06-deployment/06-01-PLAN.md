---
phase: 06-deployment
plan: 01
type: execute
---

<objective>
Deploy LahStats backend to Fly.io for hackathon demo.

Purpose: Get backend API running in the cloud so judges can access the demo.
Output: Deployed FastAPI backend on Fly.io with public URL.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@backend/config.py
@backend/main.py

**Architecture:**
- Backend: FastAPI with external ML API (Colab) integration
- Database: Supabase PostgreSQL (already cloud-hosted)
- Auth: Supabase Auth (already cloud-hosted)
- ML: Colab notebook exposed via ngrok (user manages separately)

**Key env vars needed for backend:**
- SUPABASE_URL
- SUPABASE_JWT_SECRET
- SUPABASE_SERVICE_ROLE_KEY
- REDIS_URL (Fly Redis or Upstash)
- TRANSCRIPTION_API_URL (Colab ngrok URL)
- HUGGINGFACE_TOKEN
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend Dockerfile for Fly.io</name>
  <files>backend/Dockerfile, backend/.dockerignore</files>
  <action>
Create production Dockerfile for FastAPI backend:
- Use python:3.11-slim base image
- Install system dependencies (ffmpeg for audio processing)
- Copy requirements.txt and install Python deps
- Copy backend code
- Expose port 8080 (Fly.io default)
- CMD: uvicorn main:app --host 0.0.0.0 --port 8080

Create .dockerignore to exclude: __pycache__, .env, .git, venv, *.pyc, .pytest_cache, tests/

Do NOT include ML model files - backend uses external API via TRANSCRIPTION_API_URL.
  </action>
  <verify>Dockerfile syntax is valid, .dockerignore exists</verify>
  <done>Dockerfile and .dockerignore exist in backend/, ready for Fly.io deployment</done>
</task>

<task type="auto">
  <name>Task 2: Create fly.toml and deploy to Fly.io</name>
  <files>backend/fly.toml</files>
  <action>
1. Create backend/fly.toml:
```toml
app = "lahstats-api"
primary_region = "sin"

[build]

[http_service]
  internal_port = 8080
  force_https = true
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 0

[env]
  DEBUG = "false"
  API_HOST = "0.0.0.0"
  API_PORT = "8080"
```

2. If app not created yet: `fly apps create lahstats-api` (or use existing app name)

3. Set secrets via Fly CLI:
```bash
cd backend
fly secrets set SUPABASE_URL="<value>"
fly secrets set SUPABASE_JWT_SECRET="<value>"
fly secrets set SUPABASE_SERVICE_ROLE_KEY="<value>"
fly secrets set HUGGINGFACE_TOKEN="<value>"
fly secrets set TRANSCRIPTION_API_URL="<colab_ngrok_url>"
fly secrets set REDIS_URL="<upstash_or_fly_redis_url>"
```

4. Deploy: `fly deploy`

5. Get URL: `fly status` (shows the .fly.dev URL)
  </action>
  <verify>`fly status` shows app running, `curl https://lahstats-api.fly.dev/health` returns 200</verify>
  <done>Backend deployed to Fly.io with public URL accessible</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Backend API deployed to Fly.io</what-built>
  <how-to-verify>
    1. Note the Fly.io URL (e.g., https://lahstats-api.fly.dev)
    2. Visit: https://YOUR-FLY-URL/docs (FastAPI Swagger UI)
    3. Confirm: Swagger page loads showing all endpoints
    4. Test: Try GET /health endpoint returns {"status": "ok"}
  </how-to-verify>
  <resume-signal>Provide the Fly.io URL and confirm API is accessible, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] backend/Dockerfile exists and is valid
- [ ] backend/fly.toml exists
- [ ] Backend deployed to Fly.io
- [ ] Fly.io URL is publicly accessible
- [ ] /health or /docs endpoint responds
</verification>

<success_criteria>
- Backend Dockerfile created
- fly.toml configured
- Backend deployed to Fly.io with public URL
- API endpoints accessible from internet
- Ready for frontend deployment in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/06-deployment/06-01-SUMMARY.md`:

# Phase 6 Plan 01: Backend Deployment Summary

**[Deployed FastAPI backend to Fly.io at URL]**

## Accomplishments
- Created production Dockerfile
- Configured fly.toml
- Deployed to Fly.io
- API accessible at: [URL]

## Files Created/Modified
- `backend/Dockerfile` - Production container config
- `backend/.dockerignore` - Build exclusions
- `backend/fly.toml` - Fly.io config

## Decisions Made
[Any decisions about deployment config]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 06-02-PLAN.md (Frontend deployment)
</output>
